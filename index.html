<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unity Pro - Laboratory Procurement</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
:root {
  --primary:#0f766e;--primary-h:#0d9488;--primary-bright:#14b8a6;
  --primary-l:rgba(20,184,166,0.15);
  --success:#22c55e;--success-l:rgba(34,197,94,0.15);
  --warning:#f59e0b;--warning-l:rgba(245,158,11,0.15);
  --danger:#ef4444;--danger-l:rgba(239,68,68,0.15);
  --info:#0ea5e9;--info-l:rgba(14,165,233,0.15);
  --bg:#0f0f14;--bg-card:#1a1a22;--bg-hover:#22222c;
  --text:#f0f0f5;--text-muted:#7a7a8a;--border:#2a2a36;
  --g50:#1a1a22;--g100:#22222c;--g200:#2a2a36;--g300:#3a3a46;--g400:#5a5a6a;--g500:#7a7a8a;
  --sidebar-width:220px;--sidebar-collapsed:56px;--topbar-height:48px;
  --font-base:13px;--font-sm:12px;--font-xs:11px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',system-ui,sans-serif;font-size:var(--font-base);line-height:1.5;color:var(--text);background:var(--bg)}

.loading{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999}
.loading .logo{width:64px;height:64px;background:var(--primary);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:28px;color:#fff;margin-bottom:20px}
.spinner{width:32px;height:32px;border:3px solid var(--g300);border-top-color:var(--primary-bright);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.auth{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0f172a,#1e293b)}
.auth-card{background:var(--bg-card);border-radius:16px;padding:40px;text-align:center;max-width:400px;width:90%;border:1px solid var(--border)}
.auth-logo{width:72px;height:72px;background:var(--primary);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:32px;color:#fff;margin:0 auto 16px}
.auth-card h1{font-size:24px;margin-bottom:4px}
.auth-card p{color:var(--text-muted);font-size:var(--font-sm);margin-bottom:24px}
.auth-tabs{display:flex;gap:8px;margin-bottom:24px}
.auth-tab{flex:1;padding:10px;border:none;background:var(--g100);border-radius:6px;cursor:pointer;font-weight:500;font-size:var(--font-sm);color:var(--text-muted)}
.auth-tab:hover{background:var(--g200);color:var(--text)}
.auth-tab.active{background:var(--primary);color:#fff}
.auth-form{display:flex;flex-direction:column;gap:16px;text-align:left}
.form-group label{display:block;font-size:var(--font-xs);font-weight:500;color:var(--text-muted);margin-bottom:6px}
.form-group input,.form-select,.form-textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;font-size:var(--font-sm);background:var(--bg);color:var(--text)}
.form-group input:focus,.form-select:focus{outline:none;border-color:var(--primary)}
.auth-btn{padding:12px;background:var(--primary);color:#fff;border:none;border-radius:6px;font-size:var(--font-sm);font-weight:600;cursor:pointer}
.auth-btn:hover{background:var(--primary-h)}
.auth-btn:disabled{opacity:0.5}
.auth-error{background:var(--danger-l);color:var(--danger);padding:10px;border-radius:6px;font-size:var(--font-xs);display:none;margin-bottom:16px}
.auth-error.show{display:block}

.app{display:flex;height:100vh;overflow:hidden}
.sidebar{width:var(--sidebar-width);height:100vh;position:fixed;left:0;top:0;background:#0a0a0e;border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:100;transition:width 0.2s}
.sidebar-header{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--border)}
.sidebar-logo{width:36px;height:36px;background:var(--primary);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;color:#fff}
.sidebar-brand h1{font-size:14px;font-weight:600;color:#fff}
.sidebar-brand span{font-size:10px;color:var(--g500)}
.sidebar-nav{flex:1;overflow-y:auto;padding:8px 0}
.nav-section{padding:16px 16px 6px;font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:#555}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;margin:2px 8px;font-size:var(--font-sm);color:#888;border-radius:6px;cursor:pointer;border:none;background:none;width:calc(100% - 16px);text-align:left}
.nav-item:hover{background:rgba(255,255,255,0.08);color:#ccc}
.nav-item.active{background:var(--primary);color:#fff}
.nav-item i{width:20px;text-align:center}
.nav-badge{margin-left:auto;padding:2px 8px;font-size:10px;font-weight:600;background:rgba(255,255,255,0.15);border-radius:4px}
.nav-badge.warn{background:var(--warning);color:#000}
.sidebar-footer{padding:12px;border-top:1px solid var(--border)}
.sidebar-user{display:flex;align-items:center;gap:10px;padding:8px;cursor:pointer;border-radius:6px}
.sidebar-user:hover{background:rgba(255,255,255,0.05)}
.sidebar-avatar{width:32px;height:32px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:11px;color:#fff}
.sidebar-user-info div:first-child{font-size:var(--font-xs);font-weight:500;color:#fff}
.sidebar-user-info div:last-child{font-size:10px;color:var(--g500)}

.main{flex:1;margin-left:var(--sidebar-width);display:flex;flex-direction:column;height:100vh;overflow:hidden}
.topbar{height:var(--topbar-height);background:var(--bg-card);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px}
.topbar-title{font-size:15px;font-weight:600}
.topbar-actions{display:flex;gap:8px;margin-left:auto}
.topbar-btn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;border:none;background:none;color:var(--text-muted);border-radius:6px;cursor:pointer}
.topbar-btn:hover{background:var(--bg-hover);color:var(--text)}

.page{flex:1;overflow-y:auto;padding:20px}
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.page-title{font-size:18px;font-weight:600;display:flex;align-items:center;gap:10px}
.page-title i{color:var(--text-muted)}

.stats{display:flex;gap:16px;margin-bottom:20px;flex-wrap:wrap}
.stat{flex:1;min-width:180px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:20px;display:flex;align-items:center;gap:16px}
.stat-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
.stat-icon.warning{background:var(--warning-l);color:var(--warning)}
.stat-icon.info{background:var(--info-l);color:var(--info)}
.stat-icon.success{background:var(--success-l);color:var(--success)}
.stat-icon.danger{background:var(--danger-l);color:var(--danger)}
.stat-label{font-size:var(--font-xs);color:var(--text-muted);margin-bottom:4px}
.stat-value{font-size:24px;font-weight:700}

.card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;margin-bottom:20px}
.card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-title{font-size:14px;font-weight:600}
.card-body{padding:20px}
.card-body.no-pad{padding:0}

table{width:100%;border-collapse:collapse}
th,td{padding:12px 16px;text-align:left;border-bottom:1px solid var(--border);font-size:var(--font-sm)}
th{font-size:var(--font-xs);font-weight:600;color:var(--text-muted);text-transform:uppercase;background:var(--g50)}
tbody tr:hover{background:var(--bg-hover)}

.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;border-radius:6px;font-size:var(--font-sm);font-weight:500;cursor:pointer;border:none}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{background:var(--primary-h)}
.btn-secondary{background:var(--g200);color:var(--text)}
.btn-danger{background:var(--danger);color:#fff}
.btn-sm{padding:6px 12px;font-size:var(--font-xs)}

.badge{display:inline-flex;padding:4px 10px;border-radius:4px;font-size:var(--font-xs);font-weight:500}
.badge-success{background:var(--success-l);color:var(--success)}
.badge-warning{background:var(--warning-l);color:var(--warning)}
.badge-danger{background:var(--danger-l);color:var(--danger)}
.badge-info{background:var(--info-l);color:var(--info)}
.badge-gray{background:var(--g200);color:var(--text-muted)}
.badge-primary{background:var(--primary-l);color:var(--primary-bright)}

.empty{text-align:center;padding:60px 20px;color:var(--text-muted)}
.empty i{font-size:48px;margin-bottom:16px;opacity:0.5}
.empty h3{color:var(--text);margin-bottom:8px}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden}
.modal-overlay.show{opacity:1;visibility:visible}
.modal{background:var(--bg-card);border-radius:12px;width:90%;max-width:500px;max-height:90vh;overflow:hidden;border:1px solid var(--border)}
.modal-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:16px;font-weight:600}
.modal-close{width:32px;height:32px;border:none;background:var(--g100);border-radius:6px;cursor:pointer;color:var(--text-muted)}
.modal-close:hover{background:var(--g200)}
.modal-body{padding:20px;overflow-y:auto;max-height:60vh}
.modal-footer{padding:20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}
.form-group{margin-bottom:20px}
.form-label{display:block;font-size:var(--font-xs);font-weight:500;margin-bottom:8px;color:var(--text-muted)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}

.toast-container{position:fixed;top:20px;right:20px;z-index:2000}
.toast{padding:14px 20px;border-radius:8px;margin-bottom:10px;font-size:var(--font-sm);display:flex;align-items:center;gap:10px;animation:slideIn 0.3s}
.toast.success{background:var(--success-l);color:var(--success);border:1px solid var(--success)}
.toast.error{background:var(--danger-l);color:var(--danger);border:1px solid var(--danger)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

.pending-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg)}
.pending-box{text-align:center;max-width:400px;padding:40px}
.pending-icon{width:80px;height:80px;background:var(--warning-l);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;color:var(--warning);margin:0 auto 24px}
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div class="logo"><i class="fas fa-flask"></i></div>
    <div class="spinner"></div>
  </div>
  <div id="auth" class="auth" style="display:none"></div>
  <div id="app" style="display:none"></div>
  <div id="toast-container" class="toast-container"></div>

<script>
const SUPABASE_URL = 'https://mgzywirbrwmdaabtyuye.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nenl3aXJicndtZGFhYnR5dXllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2MDg5MjUsImV4cCI6MjA4MjE4NDkyNX0.wgKtirYhhxpVifKP69vFayWLDWToHnPBkHThaSIboQk';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let currentProfile = null;

const Toast = {
  show(msg, type = 'success') {
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>${msg}`;
    document.getElementById('toast-container').appendChild(el);
    setTimeout(() => el.remove(), 4000);
  }
};

// API helper using fetch (more reliable than Supabase client)
const API = {
  headers() {
    const h = { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' };
    if (currentUser) h['Authorization'] = `Bearer ${currentUser.access_token || SUPABASE_KEY}`;
    return h;
  },
  async get(table, query = '') {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, { headers: this.headers() });
    return res.json();
  },
  async insert(table, data) {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
      method: 'POST', headers: { ...this.headers(), 'Prefer': 'return=representation' }, body: JSON.stringify(data)
    });
    const json = await res.json();
    return json[0];
  },
  async update(table, id, data) {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, {
      method: 'PATCH', headers: { ...this.headers(), 'Prefer': 'return=representation' }, body: JSON.stringify(data)
    });
    return res.json();
  },
  async delete(table, id) {
    await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, { method: 'DELETE', headers: this.headers() });
  }
};

function renderAuth() {
  document.getElementById('auth').innerHTML = `
    <div class="auth-card">
      <div class="auth-logo"><i class="fas fa-flask"></i></div>
      <h1>Unity Pro</h1>
      <p>Laboratory Procurement Management</p>
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="showTab('login')">Sign In</button>
        <button class="auth-tab" onclick="showTab('signup')">Sign Up</button>
      </div>
      <div id="auth-error" class="auth-error"></div>
      <form id="login-form" class="auth-form" onsubmit="handleLogin(event)">
        <div class="form-group"><label>Email</label><input type="email" id="login-email" required></div>
        <div class="form-group"><label>Password</label><input type="password" id="login-password" required></div>
        <button type="submit" class="auth-btn">Sign In</button>
      </form>
      <form id="signup-form" class="auth-form" style="display:none" onsubmit="handleSignup(event)">
        <div class="form-group"><label>Full Name</label><input type="text" id="signup-name" required></div>
        <div class="form-group"><label>Email</label><input type="email" id="signup-email" required></div>
        <div class="form-group"><label>Password</label><input type="password" id="signup-password" required minlength="6"></div>
        <button type="submit" class="auth-btn">Create Account</button>
      </form>
    </div>`;
}

function showTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t, i) => t.classList.toggle('active', (tab === 'login') === (i === 0)));
  document.getElementById('login-form').style.display = tab === 'login' ? 'flex' : 'none';
  document.getElementById('signup-form').style.display = tab === 'signup' ? 'flex' : 'none';
}

function showError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.classList.add('show');
}

async function handleLogin(e) {
  e.preventDefault();
  const { data, error } = await supabase.auth.signInWithPassword({
    email: document.getElementById('login-email').value,
    password: document.getElementById('login-password').value
  });
  if (error) showError(error.message);
  else await initApp(data.session);
}

async function handleSignup(e) {
  e.preventDefault();
  const { error } = await supabase.auth.signUp({
    email: document.getElementById('signup-email').value,
    password: document.getElementById('signup-password').value,
    options: { data: { name: document.getElementById('signup-name').value } }
  });
  if (error) showError(error.message);
  else { Toast.show('Check your email to confirm!'); showTab('login'); }
}

async function handleLogout() {
  await supabase.auth.signOut();
  currentUser = null;
  currentProfile = null;
  document.getElementById('app').style.display = 'none';
  document.getElementById('auth').style.display = 'flex';
}

async function loadProfile() {
  if (!currentUser) return null;
  const profiles = await API.get('profiles', `id=eq.${currentUser.id}&select=*`);
  currentProfile = profiles?.[0] || null;
  return currentProfile;
}

async function initApp(session) {
  if (!session?.user) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('auth').style.display = 'flex';
    renderAuth();
    return;
  }
  
  currentUser = session.user;
  currentUser.access_token = session.access_token;
  await loadProfile();
  
  document.getElementById('loading').style.display = 'none';
  document.getElementById('auth').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  
  if (!currentProfile?.approved) {
    renderPending();
  } else {
    App.init();
  }
}

function renderPending() {
  document.getElementById('app').innerHTML = `
    <div class="pending-screen">
      <div class="pending-box">
        <div class="pending-icon"><i class="fas fa-clock"></i></div>
        <h2>Pending Approval</h2>
        <p style="color:var(--text-muted);margin:16px 0">Your account is waiting for admin approval.</p>
        <p style="font-size:13px;color:var(--text-muted)">Signed in as: ${currentUser?.email}</p>
        <button class="btn btn-secondary" style="margin-top:20px" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
      </div>
    </div>`;
}

const App = {
  page: 'dashboard',
  data: { vendors: [], products: [], orders: [], activity: [], team: [] },
  
  async init() {
    await this.loadData();
    this.render();
  },
  
  async loadData() {
    this.data.vendors = await API.get('vendors', 'select=*&order=created_at.desc') || [];
    this.data.products = await API.get('products', 'select=*&order=created_at.desc') || [];
    this.data.orders = await API.get('orders', 'select=*&order=created_at.desc') || [];
    this.data.activity = await API.get('activity', 'select=*&order=created_at.desc&limit=20') || [];
    if (currentProfile?.role === 'admin') {
      this.data.team = await API.get('profiles', 'select=*&order=created_at.desc') || [];
    }
  },
  
  navigate(page) { this.page = page; this.render(); },
  
  render() {
    const initials = currentProfile?.name?.split(' ').map(n => n[0]).join('').toUpperCase() || 'U';
    const pendingUsers = this.data.team.filter(u => !u.approved).length;
    
    document.getElementById('app').innerHTML = `
      <div class="app">
        <aside class="sidebar">
          <div class="sidebar-header">
            <div class="sidebar-logo"><i class="fas fa-flask"></i></div>
            <div class="sidebar-brand"><h1>Unity Pro</h1><span>Lab Procurement</span></div>
          </div>
          <nav class="sidebar-nav">
            <div class="nav-section">Main</div>
            <button class="nav-item${this.page === 'dashboard' ? ' active' : ''}" onclick="App.navigate('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
            <button class="nav-item${this.page === 'orders' ? ' active' : ''}" onclick="App.navigate('orders')"><i class="fas fa-shopping-cart"></i> Orders</button>
            <button class="nav-item${this.page === 'products' ? ' active' : ''}" onclick="App.navigate('products')"><i class="fas fa-box"></i> Products</button>
            <button class="nav-item${this.page === 'vendors' ? ' active' : ''}" onclick="App.navigate('vendors')"><i class="fas fa-building"></i> Vendors</button>
            ${currentProfile?.role === 'admin' ? `
              <div class="nav-section">Admin</div>
              <button class="nav-item${this.page === 'team' ? ' active' : ''}" onclick="App.navigate('team')"><i class="fas fa-users"></i> Team ${pendingUsers ? `<span class="nav-badge warn">${pendingUsers}</span>` : ''}</button>
            ` : ''}
          </nav>
          <div class="sidebar-footer">
            <div class="sidebar-user" onclick="if(confirm('Sign out?'))handleLogout()">
              <div class="sidebar-avatar">${initials}</div>
              <div class="sidebar-user-info"><div>${currentProfile?.name || 'User'}</div><div>${currentProfile?.role || 'user'}</div></div>
            </div>
          </div>
        </aside>
        <main class="main">
          <header class="topbar">
            <div class="topbar-title">${this.getTitle()}</div>
            <div class="topbar-actions">
              <button class="topbar-btn" onclick="App.loadData().then(()=>App.render())" title="Refresh"><i class="fas fa-sync-alt"></i></button>
            </div>
          </header>
          <div class="page">${this.renderPage()}</div>
        </main>
      </div>`;
  },
  
  getTitle() {
    return { dashboard: 'Dashboard', orders: 'Orders', products: 'Products', vendors: 'Vendors', team: 'Team Management' }[this.page] || 'Unity Pro';
  },
  
  renderPage() {
    return Pages[this.page] ? Pages[this.page]() : '<p>Page not found</p>';
  }
};

const Pages = {
  dashboard() {
    const o = App.data.orders, p = App.data.products;
    const pending = o.filter(x => x.status === 'draft' || x.status === 'pending').length;
    const active = o.filter(x => x.status === 'ordered').length;
    const value = o.filter(x => x.status !== 'cancelled').reduce((s, x) => s + (parseFloat(x.total) || 0), 0);
    const low = p.filter(x => (x.on_hand || 0) <= (x.min_qty || 0)).length;
    
    return `
      <div class="stats">
        <div class="stat"><div class="stat-icon warning"><i class="fas fa-clock"></i></div><div><div class="stat-label">Pending Orders</div><div class="stat-value">${pending}</div></div></div>
        <div class="stat"><div class="stat-icon info"><i class="fas fa-truck"></i></div><div><div class="stat-label">Active Orders</div><div class="stat-value">${active}</div></div></div>
        <div class="stat"><div class="stat-icon success"><i class="fas fa-dollar-sign"></i></div><div><div class="stat-label">Open Value</div><div class="stat-value">$${value.toFixed(2)}</div></div></div>
        <div class="stat"><div class="stat-icon danger"><i class="fas fa-exclamation-triangle"></i></div><div><div class="stat-label">Low Stock</div><div class="stat-value">${low}</div></div></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Recent Activity</div></div>
        <div class="card-body no-pad">
          ${App.data.activity.length === 0 ? '<div class="empty"><i class="fas fa-history"></i><h3>No activity yet</h3></div>' :
            `<table><thead><tr><th>Action</th><th>Type</th><th>User</th><th>Time</th></tr></thead><tbody>
            ${App.data.activity.slice(0, 10).map(a => `<tr><td><span class="badge badge-primary">${a.action || '-'}</span></td><td>${a.entity_type || '-'}</td><td>${a.user_name || '-'}</td><td>${new Date(a.created_at).toLocaleString()}</td></tr>`).join('')}
            </tbody></table>`}
        </div>
      </div>`;
  },
  
  orders() {
    return `
      <div class="page-header">
        <div class="page-title"><i class="fas fa-shopping-cart"></i> Orders</div>
        <button class="btn btn-primary" onclick="Modal.createOrder()"><i class="fas fa-plus"></i> New Order</button>
      </div>
      <div class="card">
        <div class="card-body no-pad">
          ${App.data.orders.length === 0 ? '<div class="empty"><i class="fas fa-shopping-cart"></i><h3>No orders yet</h3></div>' :
            `<table><thead><tr><th>PO Number</th><th>Vendor</th><th>Status</th><th>Total</th><th>Date</th></tr></thead><tbody>
            ${App.data.orders.map(o => {
              const v = App.data.vendors.find(x => x.id === o.vendor_id);
              return `<tr><td><strong>${o.po_number}</strong></td><td>${v?.name || '-'}</td><td><span class="badge badge-${o.status === 'draft' ? 'gray' : 'info'}">${o.status}</span></td><td>$${(o.total || 0).toFixed(2)}</td><td>${new Date(o.created_at).toLocaleDateString()}</td></tr>`;
            }).join('')}
            </tbody></table>`}
        </div>
      </div>`;
  },
  
  products() {
    return `
      <div class="page-header">
        <div class="page-title"><i class="fas fa-box"></i> Products</div>
        <button class="btn btn-primary" onclick="Modal.createProduct()"><i class="fas fa-plus"></i> Add Product</button>
      </div>
      <div class="card">
        <div class="card-body no-pad">
          ${App.data.products.length === 0 ? '<div class="empty"><i class="fas fa-box"></i><h3>No products yet</h3></div>' :
            `<table><thead><tr><th>SKU</th><th>Name</th><th>Category</th><th>Stock</th><th>Min</th><th>Status</th></tr></thead><tbody>
            ${App.data.products.map(p => `<tr><td><strong>${p.sku}</strong></td><td>${p.name}</td><td>${p.category || '-'}</td><td>${p.on_hand || 0}</td><td>${p.min_qty || 0}</td><td>${(p.on_hand || 0) <= (p.min_qty || 0) ? '<span class="badge badge-danger">Low</span>' : '<span class="badge badge-success">OK</span>'}</td></tr>`).join('')}
            </tbody></table>`}
        </div>
      </div>`;
  },
  
  vendors() {
    return `
      <div class="page-header">
        <div class="page-title"><i class="fas fa-building"></i> Vendors</div>
        <button class="btn btn-primary" onclick="Modal.createVendor()"><i class="fas fa-plus"></i> Add Vendor</button>
      </div>
      <div class="card">
        <div class="card-body no-pad">
          ${App.data.vendors.length === 0 ? '<div class="empty"><i class="fas fa-building"></i><h3>No vendors yet</h3></div>' :
            `<table><thead><tr><th>Code</th><th>Name</th><th>Contact</th><th>Email</th><th>Phone</th></tr></thead><tbody>
            ${App.data.vendors.map(v => `<tr><td><strong>${v.code}</strong></td><td>${v.name}</td><td>${v.contact || '-'}</td><td>${v.email || '-'}</td><td>${v.phone || '-'}</td></tr>`).join('')}
            </tbody></table>`}
        </div>
      </div>`;
  },
  
  team() {
    if (currentProfile?.role !== 'admin') return '<div class="empty"><i class="fas fa-lock"></i><h3>Admin Only</h3></div>';
    const pending = App.data.team.filter(u => !u.approved);
    const approved = App.data.team.filter(u => u.approved);
    
    return `
      <div class="page-header"><div class="page-title"><i class="fas fa-users"></i> Team Management</div></div>
      ${pending.length > 0 ? `
        <div class="card" style="border-color:var(--warning)">
          <div class="card-header" style="background:var(--warning-l)"><div class="card-title"><i class="fas fa-clock" style="color:var(--warning);margin-right:8px"></i>Pending Approval (${pending.length})</div></div>
          <div class="card-body no-pad">
            <table><thead><tr><th>Name</th><th>Email</th><th>Date</th><th>Actions</th></tr></thead><tbody>
            ${pending.map(u => `<tr><td>${u.name || '-'}</td><td>${u.email}</td><td>${new Date(u.created_at).toLocaleDateString()}</td><td><button class="btn btn-primary btn-sm" onclick="TeamActions.approve('${u.id}')">Approve</button> <button class="btn btn-danger btn-sm" onclick="TeamActions.reject('${u.id}')">Reject</button></td></tr>`).join('')}
            </tbody></table>
          </div>
        </div>
      ` : ''}
      <div class="card">
        <div class="card-header"><div class="card-title">Active Members (${approved.length})</div></div>
        <div class="card-body no-pad">
          ${approved.length === 0 ? '<div class="empty"><i class="fas fa-users"></i><h3>No members yet</h3></div>' :
            `<table><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead><tbody>
            ${approved.map(u => `<tr><td>${u.name || '-'}</td><td>${u.email}</td><td><span class="badge ${u.role === 'admin' ? 'badge-primary' : 'badge-gray'}">${u.role || 'user'}</span></td><td>${u.id !== currentUser.id ? `<button class="btn btn-secondary btn-sm" onclick="TeamActions.toggleRole('${u.id}','${u.role}')">${u.role === 'admin' ? 'Make User' : 'Make Admin'}</button>` : '<span class="badge badge-info">You</span>'}</td></tr>`).join('')}
            </tbody></table>`}
        </div>
      </div>`;
  }
};

const TeamActions = {
  async approve(id) {
    await API.update('profiles', id, { approved: true });
    Toast.show('User approved!');
    await App.loadData(); App.render();
  },
  async reject(id) {
    if (!confirm('Reject this user?')) return;
    await API.delete('profiles', id);
    Toast.show('User rejected');
    await App.loadData(); App.render();
  },
  async toggleRole(id, role) {
    await API.update('profiles', id, { role: role === 'admin' ? 'user' : 'admin' });
    Toast.show('Role updated!');
    await App.loadData(); App.render();
  }
};

const Modal = {
  show(title, content, buttons) {
    document.body.insertAdjacentHTML('beforeend', `
      <div id="modal" class="modal-overlay show">
        <div class="modal">
          <div class="modal-header"><div class="modal-title">${title}</div><button class="modal-close" onclick="Modal.hide()"><i class="fas fa-times"></i></button></div>
          <div class="modal-body">${content}</div>
          <div class="modal-footer">${buttons}</div>
        </div>
      </div>`);
  },
  hide() { document.getElementById('modal')?.remove(); },
  
  createVendor() {
    this.show('Add Vendor', `
      <div class="form-row">
        <div class="form-group"><label class="form-label">Code</label><input class="form-group input" id="v-code" style="text-transform:uppercase"></div>
        <div class="form-group"><label class="form-label">Terms</label><select class="form-select" id="v-terms"><option value="net_30">Net 30</option><option value="net_15">Net 15</option></select></div>
      </div>
      <div class="form-group"><label class="form-label">Name</label><input class="form-group input" id="v-name"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Contact</label><input class="form-group input" id="v-contact"></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-group input" id="v-email" type="email"></div>
      </div>
      <div class="form-group"><label class="form-label">Phone</label><input class="form-group input" id="v-phone"></div>
    `, `<button class="btn btn-secondary" onclick="Modal.hide()">Cancel</button><button class="btn btn-primary" onclick="Modal.saveVendor()">Save</button>`);
  },
  
  async saveVendor() {
    const code = document.getElementById('v-code').value.trim().toUpperCase();
    const name = document.getElementById('v-name').value.trim();
    if (!code || !name) { Toast.show('Code and Name required', 'error'); return; }
    await API.insert('vendors', {
      code, name,
      contact: document.getElementById('v-contact').value,
      email: document.getElementById('v-email').value,
      phone: document.getElementById('v-phone').value,
      terms: document.getElementById('v-terms').value,
      active: true, created_by: currentUser.id
    });
    Toast.show('Vendor added!');
    this.hide();
    await App.loadData(); App.render();
  },
  
  createProduct() {
    this.show('Add Product', `
      <div class="form-row">
        <div class="form-group"><label class="form-label">SKU</label><input class="form-group input" id="p-sku"></div>
        <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="p-cat"><option value="">Select...</option><option value="consumables">Consumables</option><option value="reagents">Reagents</option><option value="ppe">PPE</option></select></div>
      </div>
      <div class="form-group"><label class="form-label">Name</label><input class="form-group input" id="p-name"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">On Hand</label><input class="form-group input" id="p-stock" type="number" value="0"></div>
        <div class="form-group"><label class="form-label">Min Qty</label><input class="form-group input" id="p-min" type="number" value="0"></div>
      </div>
    `, `<button class="btn btn-secondary" onclick="Modal.hide()">Cancel</button><button class="btn btn-primary" onclick="Modal.saveProduct()">Save</button>`);
  },
  
  async saveProduct() {
    const sku = document.getElementById('p-sku').value.trim();
    const name = document.getElementById('p-name').value.trim();
    if (!sku || !name) { Toast.show('SKU and Name required', 'error'); return; }
    await API.insert('products', {
      sku, name,
      category: document.getElementById('p-cat').value,
      on_hand: parseInt(document.getElementById('p-stock').value) || 0,
      min_qty: parseInt(document.getElementById('p-min').value) || 0,
      active: true, created_by: currentUser.id
    });
    Toast.show('Product added!');
    this.hide();
    await App.loadData(); App.render();
  },
  
  async createOrder() {
    if (App.data.vendors.length === 0) { Toast.show('Add a vendor first', 'error'); App.navigate('vendors'); return; }
    const year = new Date().getFullYear();
    const count = App.data.orders.filter(o => o.po_number?.startsWith(`ULS-${year}`)).length + 1;
    const po = `ULS-${year}-${String(count).padStart(5, '0')}`;
    
    this.show('New Order', `
      <div class="form-group"><label class="form-label">PO Number</label><input class="form-group input" id="o-po" value="${po}" readonly></div>
      <div class="form-group"><label class="form-label">Vendor</label><select class="form-select" id="o-vendor">${App.data.vendors.map(v => `<option value="${v.id}">${v.name}</option>`).join('')}</select></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="o-notes" rows="3"></textarea></div>
    `, `<button class="btn btn-secondary" onclick="Modal.hide()">Cancel</button><button class="btn btn-primary" onclick="Modal.saveOrder()">Create</button>`);
  },
  
  async saveOrder() {
    await API.insert('orders', {
      po_number: document.getElementById('o-po').value,
      vendor_id: document.getElementById('o-vendor').value,
      status: 'draft',
      notes: document.getElementById('o-notes').value,
      subtotal: 0, tax: 0, total: 0,
      created_by: currentUser.id
    });
    Toast.show('Order created!');
    this.hide();
    await App.loadData(); App.render();
  }
};

// Initialize
(async function() {
  renderAuth();
  
  // Check for existing session
  const { data: { session } } = await supabase.auth.getSession();
  await initApp(session);
  
  // Listen for auth changes
  supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN') await initApp(session);
    else if (event === 'SIGNED_OUT') {
      currentUser = null;
      currentProfile = null;
      document.getElementById('app').style.display = 'none';
      document.getElementById('auth').style.display = 'flex';
    }
  });
})();
</script>
</body>
</html>
